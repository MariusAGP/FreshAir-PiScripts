# -*- coding: utf-8 -*-

import RPi.GPIO as GPIO
import time
import board
import sys
import adafruit_dht
import mysql.connector
import datetime
import mh_z19

y=0
while y!=1:
    try:
        print("connecting SQL ...")
        conn = mysql.connector.connect(host= "sql587.main-hosting.eu",user= "u811821488_admin",passwd="#1Password",db="u811821488_freshair");
    except Exception:
        print("sql connection failed retrying...")
        pass
    else:
        y=1
dhtDevice = adafruit_dht.DHT11(board.D4, use_pulseio=False)        
status = 0     
c=conn.cursor()

def dhtreading_writesql():
    humidity = 0
    temperature = 0
    co2 = 0
    while humidity == 0:
        try:
            humidity = dhtDevice.humidity
            temperature = dhtDevice.temperature
        except Exception:
            continue
    while co2 == 0:
        try:
            mh_z19_temp = mh_z19.read_all()
            co2 = list(mh_z19_temp.values())[0]
        except Exception:
            continue
    
    if humidity is not None and co2 is not None and temperature is not None:
        print('Temperature={0:0.1f}Â°C Humidity={1:0.1f}% Co2={2}ppm'.format(temperature, humidity, co2))
    else:
        print('Failed to get reading. Try again!')
    
    if co2 <= 1100:
        LED_GREEN = 18
        GPIO.setmode(GPIO.BCM)
        
        GPIO.setup(LED_GREEN,GPIO.OUT)
        GPIO.output(LED_GREEN,GPIO.HIGH)
        time.sleep(1)
        GPIO.output(LED_GREEN,GPIO.LOW)
        
        GPIO.cleanup()
    else:
        LED_RED = 23
        GPIO.setmode(GPIO.BCM)
        
        GPIO.setup(LED_RED,GPIO.OUT)
        GPIO.output(LED_RED,GPIO.HIGH)
        time.sleep(1)
        GPIO.output(LED_RED,GPIO.LOW)
        
        GPIO.cleanup()
    
    c.execute("INSERT INTO sensordata (temperature, humidity, co2) VALUES (%s, %s, %s)",(temperature, humidity, co2))

    conn.commit()

i = 0
while i == 0:
    dhtreading_writesql()
    time.sleep(2.0)

c.close
conn.close()
